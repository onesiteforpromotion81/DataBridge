<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Bridge - CSV„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic Medium", "Ê∏∏„Ç¥„Ç∑„ÉÉ„ÇØ Medium", "YuGothic", "Ê∏∏„Ç¥„Ç∑„ÉÉ„ÇØ‰Ωì", "Noto Sans JP", "„É°„Ç§„É™„Ç™", Meiryo, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      background-attachment: fixed;
      padding: 40px 20px;
      font-size: 15px;
      color: #2c3e50;
      line-height: 1.7;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    h2 {
      font-size: 22px;
      color: #1a5490;
      border-left: 5px solid #0B63CE;
      padding: 16px 20px;
      margin: 0 0 28px 0;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
      border-radius: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(11, 99, 206, 0.08);
      position: relative;
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(11, 99, 206, 0.2), transparent);
    }

    .container {
      max-width: 680px;
      margin: 0 auto;
      background: #ffffff;
      padding: 32px 36px;
      border: 1px solid rgba(11, 99, 206, 0.1);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: box-shadow 0.3s ease;
    }

    .container:hover {
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
    }

    .form-row {
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    label {
      display: inline-block;
      min-width: 140px;
      font-weight: 600;
      color: #34495e;
      font-size: 15px;
      letter-spacing: 0.3px;
    }

    input[type="file"],
    select {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: #ffffff;
      color: #2c3e50;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    input[type="file"]:hover,
    select:hover {
      border-color: #0B63CE;
      background: #f8f9ff;
    }

    input[type="file"]:focus,
    select:focus {
      outline: none;
      border-color: #0B63CE;
      box-shadow: 0 0 0 3px rgba(11, 99, 206, 0.1);
      background: #ffffff;
    }

    button {
      background: #0B63CE;
      color: white;
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(11, 99, 206, 0.2);
      transform: translateY(0);
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover:not(:disabled) {
      background: #0a5bb8;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(11, 99, 206, 0.3);
    }

    button:hover:not(:disabled)::before {
      width: 300px;
      height: 300px;
    }

    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(11, 99, 206, 0.2);
      transition: all 0.1s;
    }

    button:disabled {
      background: #a9c2e5;
      cursor: not-allowed;
      transform: translateY(0);
      box-shadow: none;
      opacity: 0.7;
    }

    button:disabled::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #result {
      margin-top: 24px;
      padding: 18px 20px;
      border: 2px solid #e1e8ed;
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      white-space: pre-wrap;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.8;
      color: #2c3e50;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      transition: all 0.3s ease;
    }

    #result:empty {
      display: none;
    }

    #loader {
      display: none;
      margin: 12px 0;
      font-size: 14px;
      color: #5a6c7d;
      text-align: center;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    progress {
      width: 100%;
      margin-top: 16px;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background: #e1e8ed;
      border: none;
    }

    progress::-webkit-progress-bar {
      background: #e1e8ed;
      border-radius: 4px;
    }

    progress::-webkit-progress-value {
      background: linear-gradient(90deg, #0B63CE 0%, #0a5bb8 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    progress::-moz-progress-bar {
      background: linear-gradient(90deg, #0B63CE 0%, #0a5bb8 100%);
      border-radius: 4px;
    }

    footer {
      margin-top: 48px;
      padding-top: 24px;
      font-size: 13px;
      color: #7f8c8d;
      text-align: center;
      border-top: 1px solid #e1e8ed;
      font-weight: 400;
      letter-spacing: 0.5px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 20px 12px;
        font-size: 14px;
      }

      .container {
        padding: 24px 20px;
        border-radius: 8px;
      }

      h2 {
        font-size: 20px;
        padding: 14px 16px;
        margin-bottom: 24px;
      }

      .form-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      label {
        min-width: auto;
        width: 100%;
        margin-bottom: 4px;
      }

      input[type="file"],
      select {
        width: 100%;
      }

      button {
        width: 100%;
        padding: 12px 24px;
      }
    }

    /* Smooth scroll */
    html {
      scroll-behavior: smooth;
    }

    /* Selection color */
    ::selection {
      background: rgba(11, 99, 206, 0.2);
      color: #1a5490;
    }
  </style>
</head>

<body>

  <div class="container">
    <h2>CSV„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h2>

    <form id="uploadForm">
      
      <div class="form-row">
        <label>CSV „Éï„Ç°„Ç§„É´Ôºö</label>
        <input type="file" id="file" accept=".csv" required />
      </div>

      <div class="form-row">
        <label>„Çø„Ç§„ÉóÈÅ∏ÊäûÔºö</label>
        <select id="type"></select>
      </div>

      <div class="form-row">
        <button id="submitBtn" type="submit">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</button>
      </div>

    </form>

    <div id="loader">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>

    <progress id="progress" value="0" max="100" style="display: none;"></progress>

    <div id="result"></div>
    <footer>¬© Data Bridge System</footer>
  </div>

  <script type="module">
    const API_BASE = "https://databridge.liquorhub-demo.cloud/api/csv";

    const fileInput = document.getElementById("file");
    const typeSelect = document.getElementById("type");
    const progressBar = document.getElementById("progress");
    const loader = document.getElementById("loader");
    const submitBtn = document.getElementById("submitBtn");
    const resultDiv = document.getElementById("result");

    // Wrap fetch for reusability
    async function api(url, options = {}) {
      const res = await fetch(url, options);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Request failed");
      return data;
    }

    // Load CSV types
    async function loadTypes() {
      loader.style.display = "block";
      try {
        const data = await api(`${API_BASE}/types`);
        typeSelect.innerHTML = data.types
          .map(t => `<option value="${t}">${t}</option>`)
          .join("");
      } catch (err) {
        typeSelect.innerHTML = `<option disabled>Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº</option>`;
        console.error(err);
      } finally {
        loader.style.display = "none";
      }
    }

    loadTypes();

    // Upload CSV Handler
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const file = fileInput.files[0];
      const type = typeSelect.value;

      if (!file) {
        resultDiv.textContent = "CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
        return;
      }

      if (!file.name.endsWith(".csv")) {
        resultDiv.textContent = "CSVÂΩ¢Âºè„ÅÆ„Éï„Ç°„Ç§„É´„ÅÆ„Åø„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô„ÄÇ";
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...";
      progressBar.style.display = "block";
      progressBar.value = 0;
      resultDiv.textContent = "‚è≥ „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠‚Ä¶";
      resultDiv.style.borderColor = "#e1e8ed";
      resultDiv.style.background = "linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%)";

      const formData = new FormData();
      formData.append("file", file);
      formData.append("type", type);

      try {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", `${API_BASE}/upload`);

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            progressBar.value = Math.round((e.loaded / e.total) * 100);
          }
        };

        xhr.onload = () => {
          submitBtn.disabled = false;
          submitBtn.textContent = "„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ";
          progressBar.style.display = "none";
          if (xhr.status >= 200 && xhr.status < 300) {
            const json = JSON.parse(xhr.responseText);
            console.log("json: ", json);
            const inserted = json.inserted || 0;
            const failed = json.failed || 0;
            const skipped = json.skipped || 0;
            let message = `‚úÖ ${json.message}\n\nüìä Âá¶ÁêÜÁµêÊûúÔºö\n   ‚Ä¢ ËøΩÂä†: ${inserted} Ë°å\n`;
            if (failed > 0) message += `   ‚Ä¢ Â§±Êïó: ${failed} Ë°å\n`;
            if (skipped > 0) message += `   ‚Ä¢ „Çπ„Ç≠„ÉÉ„Éó: ${skipped} Ë°å\n`;
            message += `\nüìã „ÉÜ„Éº„Éñ„É´: "${json.tableName}"`;
            resultDiv.textContent = message;
            resultDiv.style.borderColor = "#27ae60";
            resultDiv.style.background = "linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%)";
          } else {
            resultDiv.textContent = `‚ùå „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±ÊïóÔºö\n${xhr.responseText}`;
            resultDiv.style.borderColor = "#e74c3c";
            resultDiv.style.background = "linear-gradient(135deg, #fef2f2 0%, #ffffff 100%)";
          }
        };

        xhr.onerror = () => {
          resultDiv.textContent = "‚ùå ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
          resultDiv.style.borderColor = "#e74c3c";
          resultDiv.style.background = "linear-gradient(135deg, #fef2f2 0%, #ffffff 100%)";
          submitBtn.disabled = false;
          submitBtn.textContent = "„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ";
          progressBar.style.display = "none";
        };

        xhr.send(formData);
      } catch (err) {
        resultDiv.textContent = `‚ùå „Ç®„É©„ÉºÔºö\n${err.message}`;
        resultDiv.style.borderColor = "#e74c3c";
        resultDiv.style.background = "linear-gradient(135deg, #fef2f2 0%, #ffffff 100%)";
        submitBtn.disabled = false;
        submitBtn.textContent = "„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ";
        progressBar.style.display = "none";
      }
    });
  </script>
</body>
</html>
